@model List<BTL_Web.Controllers.CartController.OrderProductDTO>

<div style="margin-top: 50px; margin-bottom: 140px; display: flex; flex-direction: column; align-items: center;">
    @if (Model.Count > 0)
    {
        <table class="table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Sản phẩm</th>
                    <th scope="col">Đơn giá</th>
                    <th scope="col">Số lượng</th>
                    <th scope="col">Xóa</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var Order in Model)
                {
                    <tr id="@Order.OrderId" style="border-bottom: 1px solid #ddd;">
                        <td style="text-align: center; padding-top: 40px;">@Order.OrderId</td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <img src="~/Images/@Order.ProductImg"
                                    style="width: 100px; height: 100px; margin-right: 10px;" />
                                <p>@Order.ProductName</p>
                            </div>
                        </td>
                        <td style=" display: flex;margin-top: 30px; border: none">
                            <div style="display: flex; align-items: center;">
                                <p>
                                    Đơn giá: @Order.ProductPrice
                                </p>
                            </div>
                        </td>
                        <td style="padding-top: 40px; ">
                            <button id="Tru" class="Tru" data-id="@Order.OrderId" onclick="decrementQuantity(this)">-</button>
                            <input style="width: 40px; text-align: center;" value="@Order.SoLuong" id="@Order.OrderId" />
                            <button id="Cong" class="Cong" data-id="@Order.OrderId" onclick="incrementQuantity(this)">+</button>
                        </td>
                        <td style="padding-top: 40px;">
                            <button data-id="@Order.OrderId" class="btn-delete">Xóa</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div style="margin-top: 20px;">
            <button id="dathang"
                style="padding: 10px 20px; font-size: 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Đặt hàng
            </button>
        </div>
    }
    else
    {
        <div style="font-size: 20px; color: red;">
            Chưa có đơn hàng nào
        </div>
    }
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

    function decrementQuantity(button) {
        var id = button.getAttribute("data-id");
        console.log(id)
        var inputElement = document.getElementById(id);
        var input_soluong = inputElement.querySelector('input').value
        var soluongAsNumber = parseInt(input_soluong, 10);

        if (soluongAsNumber > 1) {
            fetch("/Cart/SoLuongTru", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: "id=" + id// Convert to JSON string
            })
                .then((data) => {
                    return data.json()
                })
                .then((data) => {
                    console.log({ data });

                    var inputElement = document.getElementById(id);
                    if (inputElement) {
                        inputElement.querySelector('input').value = data.product.soLuong;
                    } else {
                        console.error("Input element not found!");
                    }

                })
                .catch(err => {
                    console.log(err)
                })
        }
        else {
            alert('Sản phẩm phải lơn hơn 1')
        }
    }

    function incrementQuantity(button) {
        var orderId = button.getAttribute("data-id");
        fetch("/Cart/SoLuongCong", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: "id=" + orderId
        })
            .then((data) => {
                return data.json()
            })
            .then((data) => {
                console.log({ data });
                var inputElement = document.getElementById(orderId);
                if (inputElement) {
                    inputElement.querySelector('input').value = data.product.soLuong;
                } else {
                    console.error("Input element not found!");
                }
            })
            .catch(err => {
                console.log(err)
            })
        // TODO: Update the server-side data or perform any other necessary action
    }



    //datdtj hangf
    document.getElementById('dathang').addEventListener('click', () => {
        var orderIds = [];

        $(".btn-delete").each(function () {
            orderIds.push($(this).data("id"));
        });

        console.log(orderIds)

        // Now orderIds array contains all OrderIds
        fetch("/Cart/DatHang", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",

            },
            body: JSON.stringify(orderIds)

        })
            .then((data) => {
                return data.json();
            })
            .then((data) => {
                alert('Đặt hàng thành công!!!')
                window.location.reload();
                console.log({ data });
            })
            .catch(err => {
                console.log(err);
            });
    });



    $(document).ready(function () {
        $(".btn-delete").click(function () {
            var hanghoaId = $(this).data("id");
            console.log(hanghoaId)
            if (confirm("Có chắc chắn muốn xoá không?")) {
                $.ajax({
                    url: '/Cart/DeleteCart',
                    method: 'delete',
                    data: { id: hanghoaId },
                    success: function (result) {
                        if (result.success) {
                            document.getElementById(hanghoaId).remove()
                            alert("Xoas thanh cong")
                        } else {
                            alert("Không thể xóa hàng hoá.");
                        }
                    }
                });
            }
        });
    });


</script>